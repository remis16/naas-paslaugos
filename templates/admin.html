{% extends "base.html" %}

{% block title %}Admin Panelė{% endblock %}

{% block content %}
<div class="space-y-10">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="p-4 rounded-lg shadow-md {% if category == 'success' %}bg-green-100 border-l-4 border-green-500 text-green-700{% elif category == 'error' %}bg-red-100 border-l-4 border-red-500 text-red-700{% else %}bg-blue-100 border-l-4 border-blue-500 text-blue-700{% endif %}">
                    <p class="font-bold">{{ category | title }}:</p>
                    <p>{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h1 class="text-3xl font-extrabold text-gray-900 border-b pb-2 flex items-center">
        <i data-lucide="wrench" class="w-8 h-8 mr-3 text-red-600"></i> Administratoriaus Panelė
    </h1>

    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
             <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-green-600"></i> Pridėti Naują Paslaugą
        </h2>
        
        <form method="POST" action="{{ url_for('admin') }}" enctype="multipart/form-data" class="space-y-4">
            {{ csrf_token() }}

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {% for field in [
                {'label': 'Kategorija (pvz., food_and_drinks)', 'name': 'category', 'type': 'text', 'required': true},
                {'label': 'Subkategorija (pvz., restaurants)', 'name': 'subcategory', 'type': 'text', 'required': true},
                {'label': 'Pavadinimas', 'name': 'name', 'type': 'text', 'required': true},
                {'label': 'Adresas', 'name': 'address', 'type': 'text', 'required': true},
                {'label': 'Telefonas', 'name': 'phone', 'type': 'tel', 'required': true, 'pattern': '\\+?\\d{7,15}'},
                {'label': 'Darbo Laikas', 'name': 'working_hours', 'type': 'text', 'required': true},
                {'label': 'Google Maps Nuoroda', 'name': 'maps', 'type': 'url', 'required': true},
                {'label': 'Svetainė (nebūtina)', 'name': 'website', 'type': 'url'},
                {'label': 'Paveikslėlis (nebūtina)', 'name': 'image', 'type': 'file'}
            ] %}
                <div class="{% if field.name == 'website' or field.name == 'image' %}sm:col-span-1{% else %}sm:col-span-1{% endif %}">
                    <label for="{{ field.name }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                    {% if field.type == 'file' %}
                        <input type="file" id="{{ field.name }}" name="{{ field.name }}" accept="image/*" class="form-file-input">
                    {% elif field.type == 'textarea' %}
                        <textarea id="{{ field.name }}" name="{{ field.name }}" rows="3" {% if field.required %} required {% endif %} class="form-input"></textarea>
                    {% else %}
                        <input type="{{ field.type }}" id="{{ field.name }}" name="{{ field.name }}" {% if field.required %} required {% endif %} {% if field.pattern %} pattern="{{ field.pattern }}" {% endif %} class="form-input">
                    {% endif %}
                </div>
            {% endfor %}
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">Aprašymas *</label>
                <textarea id="description" name="description" rows="3" required class="form-input"></textarea>
            </div>

            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                <i data-lucide="save" class="w-5 h-5 mr-2"></i> Įrašyti Naują Paslaugą
            </button>
        </form>
    </div>

    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mt-8 flex items-center">
        <i data-lucide="list-checks" class="w-6 h-6 mr-2 text-blue-600"></i> Esamos Paslaugos
    </h2>

    <div class="space-y-6">
        {% for category, subcategories in data.items() %}
            <div class="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                <h3 class="text-xl font-extrabold text-gray-900 mb-4">{{ category.replace('_', ' ').title() }}</h3>

                {% for subcategory, services in subcategories.items() %}
                    <h4 class="text-lg font-bold text-blue-800 mt-4 mb-2 border-l-4 border-blue-400 pl-3">{{ subcategory.replace('_', ' ').title() }} ({{ services | length }})</h4>
                    
                    <ul class="divide-y divide-gray-200">
                        {% for service in services %}
                            <li class="py-3 flex justify-between items-center hover:bg-gray-100 px-2 rounded transition">
                                <div class="flex-grow">
                                    <strong class="text-gray-900">{{ loop.index }}. {{ service.name | e }}</strong> 
                                    <span class="text-sm text-gray-500 ml-3">({{ service.address | e }})</span>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0">
                                    <a href="{{ url_for('edit_service', category=category, subcategory=subcategory, index=loop.index0) }}" 
                                       class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-50 hover:bg-red-100 transition" title="Redaguoti">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </a>

                                    <form action="{{ url_for('delete_service') }}" method="POST" onsubmit="return confirm('Ar tikrai norite ištrinti šią paslaugą? Tai veiksmas, kurio negalima atšaukti.')" class="inline-block">
                                        {{ csrf_token() }}
                                        <input type="hidden" name="category" value="{{ category }}">
                                        <input type="hidden" name="subcategory" value="{{ subcategory }}">
                                        <input type="hidden" name="index" value="{{ loop.index0 }}">
                                        <button type="submit" class="text-gray-400 hover:text-gray-600 p-1 rounded-full bg-gray-200 hover:bg-gray-300 transition" title="Ištrinti">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

</div>

<style>
    .form-input {
        @apply mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 transition;
    }
    .form-file-input {
        @apply mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition;
    }
</style>
{% endblock %}